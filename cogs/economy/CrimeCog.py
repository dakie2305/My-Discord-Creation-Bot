from CustomEnum.SlashEnum import SlashCommand
from CustomEnum.EmojiEnum import EmojiCreation2
from CustomEnum.RoleEnum import TrueHeavenRoleId
import discord
from discord.ext import commands
import Handling.Economy.Profile.ProfileMongoManager as ProfileMongoManager
from datetime import datetime, timedelta
import random
from Handling.Misc.SelfDestructView import SelfDestructView
import CustomEnum.UserEnum as UserEnum
import CustomFunctions
from discord.app_commands import Choice
import asyncio
import Handling.Economy.Quest.QuestMongoManager as QuestMongoManager
from Handling.Economy.Profile.ProfileClass import Profile
from Handling.Economy.Crime.AuthorityInterceptView import AuthorityInterceptView

async def setup(bot: commands.Bot):
    await bot.add_cog(CrimeEconomy(bot=bot))
    print("Crime Economy is ready!")

class CrimeEconomy(commands.Cog):
    def __init__(self, bot: commands.Bot):
        self.bot = bot
    
    @commands.command()
    async def crime(self, ctx):
        message: discord.Message = ctx.message
        if message:
            view = SelfDestructView(timeout=30)
            embed = discord.Embed(title=f"Kh√¥ng h·ªó tr·ª£ prefix command. Vui l√≤ng d√πng l·ªánh /crime !",color=discord.Color.blue())
            mes = await message.reply(embed=embed, view=view)
            if view != None:
                view.message = mes
            return
    
    #region crime
    @discord.app_commands.choices(action=[
        Choice(name="ƒê√°nh nhau, g√¢y g·ªó ng∆∞·ªùi kh√°c", value="fight"),
        Choice(name="C∆∞·ªõp b√≥c ng∆∞·ªùi kh√°c", value="rob"),
        Choice(name="R·ª≠a ti·ªÅn, tr·ªën thu·∫ø", value="laundry"),
        Choice(name="Bu√¥n l·∫≠u, tu·ªìn h√†ng c·∫•m", value="smuggler"),
    ])
    @discord.app_commands.describe(action="Ch·ªçn lo·∫°i h√†nh vi ph·∫°m t·ªôi.")
    @discord.app_commands.command(name="crime", description="L·ªánh th·ª±c hi·ªán c√°c h√†nh vi ph·∫°m t·ªôi!")
    async def crime_slash_command(self, interaction: discord.Interaction, action: str, target_user: discord.Member):
        await interaction.response.defer(ephemeral=True)
        #Kh√¥ng cho d√πng bot n·∫øu kh√¥ng ph·∫£i user
        if CustomFunctions.check_if_dev_mode() == True and interaction.user.id != UserEnum.UserId.DARKIE.value:
            view = SelfDestructView(timeout=30)
            embed = discord.Embed(title=f"Darkie ƒëang nghi√™n c·ª©u, c·∫≠p nh·∫≠t v√† s·ª≠a ch·ªØa bot! Vui l√≤ng ƒë·ª£i nh√©!",color=discord.Color.blue())
            mess = await interaction.followup.send(embed=embed, view=view, ephemeral=True)
            view.message = mess
            return
        
        #Ph·∫£i t·ªìn t·∫°i ch√≠nh quy·ªÅn server th√¨ m·ªõi ƒë∆∞·ª£c crime
        authority = ProfileMongoManager.get_authority(guild_id=interaction.guild.id)
        if authority == None:
            embed = discord.Embed(title=f"", description=f"Server v·∫´n ch∆∞a t·ªìn t·∫°i Ch√≠nh Quy·ªÅn. Vui l√≤ng d√πng l·ªánh {SlashCommand.VOTE_AUTHORITY.value} ƒë·ªÉ b·∫ßu Ch√≠nh Quy·ªÅn m·ªõi!", color=0xddede7)
            await interaction.followup.send(embed=embed)
            return
        
        authority_user = self.bot.get_guild(interaction.guild.id).get_member(authority.user_id)
        # N·∫øu kh√¥ng get ƒë∆∞·ª£c t·ª©c l√† authority kh√¥ng trong server
        if authority_user == None:
            embed = discord.Embed(title=f"", description=f"Ch√≠nh Quy·ªÅn ƒë√£ l∆∞u vong kh·ªèi server. Vui l√≤ng d√πng l·ªánh {SlashCommand.VOTE_AUTHORITY.value} ƒë·ªÉ b·∫ßu Ch√≠nh Quy·ªÅn m·ªõi!", color=0xddede7)
            ProfileMongoManager.remove_authority_from_server(guild_id=interaction.guild.id)
            ProfileMongoManager.update_last_authority(guild_id=interaction.user.guild.id, user_id=authority.user_id)
            await interaction.followup.send(embed=embed)
            return
        
        #Ki·ªÉm xem ch√≠nh quy·ªÅn c√≥ m·∫∑c n·ª£ kh√¥ng, c√≥ th√¨ t·ª´ ch·ª©c v√† ph·∫°t authority
        if ProfileMongoManager.is_in_debt(data= authority, copper_threshold=100000):
            embed = discord.Embed(title=f"", description=f"Ch√≠nh Quy·ªÅn ƒë√£ n·ª£ n·∫ßn qu√° nhi·ªÅu v√† t·ª± s·ª•p ƒë·ªï. H√£y d√πng l·ªánh {SlashCommand.VOTE_AUTHORITY.value} ƒë·ªÉ b·∫ßu Ch√≠nh Quy·ªÅn m·ªõi!", color=0xddede7)
            authority.copper = -10000
            authority.silver = 0
            authority.gold = 0
            authority.darkium = 0
            ProfileMongoManager.update_profile_money_fast(guild_id= interaction.user.guild.id, data=authority)
            ProfileMongoManager.remove_authority_from_server(guild_id=interaction.user.guild.id)
            ProfileMongoManager.update_last_authority(guild_id=interaction.user.guild.id, user_id=authority.user_id)
            await interaction.followup.send(embed=embed)
            return
        
        
        if target_user.bot:
            view = SelfDestructView(30)
            embed = discord.Embed(title=f"", description=f"Kh√¥ng ƒë∆∞·ª£c ch·ªçn Bot!", color=0xe82517)
            await interaction.followup.send(embed=embed, view=view)
            return
        
        #N·∫øu c∆∞·ªõp, ƒë√°nh, ch·ª≠i th√¨ interaction user kh√°c target
        if action == "rob" or action == "fight" or action == "insult":
            if interaction.user.id == target_user.id:
                view = SelfDestructView(30)
                embed = discord.Embed(title=f"", description=f"B·∫°n kh√¥ng th·ªÉ ch·ªçn b·∫£n th√¢n!", color=0xe82517)
                m = await interaction.followup.send(embed=embed, view=view)
                view.message = m
                return
        
        user_profile = ProfileMongoManager.find_profile_by_id(guild_id=interaction.guild_id, user_id=interaction.user.id)
        if user_profile == None:
            user_profile = ProfileMongoManager.create_profile(guild_id=interaction.guild_id, guild_name=interaction.guild.name, user_id=interaction.user.id, user_name=interaction.user.name, user_display_name=interaction.user.display_name)
        
        target_profile = ProfileMongoManager.find_profile_by_id(guild_id=interaction.guild_id, user_id=target_user.id)
        if target_profile == None:
            target_profile = ProfileMongoManager.create_profile(guild_id=interaction.guild_id, guild_name=interaction.guild.name, user_id=target_user.id, user_name=target_user.name, user_display_name=target_user.display_name)
        
        #Kh√¥ng cho th·ª±c hi·ªán n·∫øu c√≤n jail_time
        if user_profile != None and user_profile.jail_time != None:
            if user_profile.jail_time > datetime.now():
                unix_time = int(user_profile.jail_time.timestamp())
                embed = discord.Embed(title=f"", description=f"‚õìÔ∏è B·∫°n ƒë√£ b·ªã ch√≠nh quy·ªÅn b·∫Øt gi·ªØ r·ªìi, vui l√≤ng ƒë·ª£i ƒë·∫øn <t:{unix_time}:t> ƒë·ªÉ th·ª±c hi·ªán l·∫°i l·ªánh!", color=0xc379e0)
                view = SelfDestructView(60)
                m = await interaction.followup.send(embed=embed, view=view)
                view.message = m
                return
        
        #N·∫øu qu√° ngh√®o th√¨ b·ªè
        if action == "rob" and target_profile.copper < 10000 and target_profile.silver <= 0 and target_profile.gold <= 0:
            print(f"target_profile.copper: {target_profile.copper} target_profile.silver {target_profile.silver} target_profile.gold {target_profile.gold}")
            view = SelfDestructView(60)
            embed = discord.Embed(title=f"", description=f"{target_user.mention} qu√° ngh√®o, b·∫°n kh√¥ng th·ªÉ c∆∞·ªõp c·ªßa ng∆∞·ªùi c√≥ ƒë·ªãa v·ªã H·∫° ƒê·∫≥ng!", color=0xe82517)
            m = await interaction.followup.send(embed=embed, view=view)
            view.message = m
            return
        #N·∫øu h∆°n ng∆∞·ªùi ta 10 level th√¨ kh√¥ng cho c∆∞·ªõp n·ªØa
        elif action == "rob" and (user_profile.level -10 > target_profile.level):
            view = SelfDestructView(30)
            embed = discord.Embed(title=f"", description=f"{target_user.mention} c·∫•p qu√° th·∫•p, b·∫°n kh√¥ng th·ªÉ c∆∞·ªõp c·ªßa ng∆∞·ªùi th·∫•p h∆°n m√¨nh 10 c·∫•p!", color=0xe82517)
            m = await interaction.followup.send(embed=embed, view=view)
            view.message = m
            return
        #ƒê√°nh nhau m√† kh√¥ng c√≤n ƒëi·ªÉm nh√¢n ph·∫©m th√¨ kh√¥ng cho ƒë√°nh nhau
        elif user_profile.dignity_point <= 10:
            view = SelfDestructView(30)
            embed = discord.Embed(title=f"", description=f"ƒêi·ªÉm nh√¢n ph·∫©m b·∫°n qu√° th·∫•p, h√£y tƒÉng nh√¢n ph·∫©m b·∫±ng c√°ch d√πng l·ªánh {SlashCommand.WORK.value} ho·∫∑c {SlashCommand.DAILY.value} tr∆∞·ªõc ƒëi!", color=0xe82517)
            m = await interaction.followup.send(embed=embed, view=view)
            view.message = m
            return
        
        #N·∫øu bu√¥n l·∫≠u th√¨ c·∫ßn √≠t nh·∫•t 2000 Copper trong profile
        elif action == "smuggler" and user_profile.copper < 2000:
            view = SelfDestructView(30)
            embed = discord.Embed(title=f"", description=f"{interaction.user.mention} c·∫ßn √≠t nh·∫•t 2000 {EmojiCreation2.COPPER.value} ƒë·ªÉ th·ª±c hi·ªán bu√¥n l·∫≠u!", color=0xe82517)
            m = await interaction.followup.send(embed=embed, view=view)
            view.message = m
            return
        
        elif user_profile != None and user_profile.last_crime != None:
            time_window = timedelta(hours=1)
            check = self.check_if_within_time_delta(input=user_profile.last_crime, time_window=time_window)
            if check:
                #L·∫•y th·ªùi gian c≈© ƒë·ªÉ c·ªông v√†o 1h xem ch·ª´ng n√†o m·ªõi crime ƒë∆∞·ª£c ti·∫øp
                crime_next_time = user_profile.last_crime + time_window
                unix_time = int(crime_next_time.timestamp())
                embed = discord.Embed(title=f"", description=f"üö´ B·∫°n ƒë√£ l√†m vi·ªác x·∫•u r·ªìi. Vui l√≤ng th·ª±c hi·ªán l·∫°i l·ªánh {SlashCommand.CRIME.value} v√†o l√∫c <t:{unix_time}:t> !", color=0xc379e0)
                view = SelfDestructView(timeout=30)
                m = await interaction.followup.send(embed=embed, view=view)
                view.message = m
                return

        if action == "fight":
            await self.process_fight_command(interaction=interaction, user=interaction.user, target_user=target_user, user_profile=user_profile, target_profile=target_profile)
        elif action == "rob":
            await self.process_rob_command(interaction=interaction, user=interaction.user, target_user=target_user, user_profile=user_profile, target_profile=target_profile)
        elif action == "laundry":
            await self.process_laundry_command(interaction=interaction, user=interaction.user, target_user=target_user, user_profile=user_profile, target_profile=target_profile)
        elif action == "smuggler":
            await self.process_smuggler_command(interaction=interaction, user=interaction.user, target_user=target_user, user_profile=user_profile, target_profile=target_profile)
        else:
            view = SelfDestructView(30)
            embed = discord.Embed(title=f"", description=f"Ch·ª©c nƒÉng n√†y v·∫´n ch∆∞a ho√†n thi·ªán, Darkie v·∫´n ƒëang code!", color=0xe82517)
            m = await interaction.followup.send(embed=embed, view=view)
            view.message = m
            return
        
    #region Rob
    async def process_rob_command(self, interaction: discord.Interaction, user: discord.Member, target_user: discord.Member, user_profile: Profile, target_profile: Profile):    
        authority_user = ProfileMongoManager.get_authority(guild_id=user.guild.id)
        #Rob s·∫Ω d·ª±a v√†o level ƒë·ªÉ x√°c ƒë·ªãnh t·ªâ l·ªá th·∫Øng c·ªßa user v√† target_user
        user_win = False
        if user_profile.is_authority == False:
            if user_profile.level + 5 < target_profile.level:
                user_win = self.get_chance(25)
            else:
                if target_profile.is_authority == True:
                    user_win = self.get_chance(40)
                else: user_win = self.get_chance(75)
        else:
            user_win = self.get_chance(40)
        
        preloading_text = f"{user.mention} ƒëang chu·∫©n b·ªã c∆∞·ªõp ti·ªÅn c·ªßa {target_user.mention}!"
        if user_profile.is_authority == False:
            preloading_text += "\nC√≥ th·ªÉ g·ªçi Ch√≠nh Quy·ªÅn v√†o cu·ªôc ƒë·ªÉ ngƒÉn ch·∫∑n c∆∞·ªõp gi·∫≠t!"
        embed = discord.Embed(title=f"", description=f"{preloading_text}", color=0xc379e0)
        view = AuthorityInterceptView(user=user, user_profile=user_profile, crime_type="rob", target_profile=target_profile, target_user=target_user, authority_user=authority_user)
        await interaction.followup.send(f"B·∫°n ƒë√£ c∆∞·ªõp gi·∫≠t!", ephemeral=True)
        #Update last_crime
        ProfileMongoManager.update_last_crime(guild_id=interaction.guild_id, user_id=user.id)
        channel = interaction.channel
        if user_profile.is_authority == False:
            me = await channel.send(embed=embed, view=view, content=f"{target_user.mention}")
        else:
            me = await channel.send(embed=embed, view=None, content=f"{target_user.mention}")
        view.old_message = me
        #ƒê·ª£i ƒë·ªÉ x√°c ƒë·ªãnh ng∆∞·ªùi th·∫Øng
        await asyncio.sleep(20)
        if view.interrupted == True: return
        
        #Ki·ªÉm tra, c√≥ item b·∫£o h·ªô th√¨ k·∫øt qu·∫£ s·∫Ω kh√°c
        if target_profile.protection_item != None:
            if target_profile.protection_item.item_id == "armor_rob_1":
                embed = discord.Embed(title=f"", description=f"{user.mention} ƒëang chu·∫©n b·ªã c∆∞·ªõp ti·ªÅn c·ªßa {target_user.mention}!", color=0xc379e0)
                embed.add_field(name=f"", value=f"{target_user.mention} ƒë√£ m·∫∑c s·∫µn [{target_profile.protection_item.emoji} - **{target_profile.protection_item.item_name}**] n√™n ƒë√£ tho√°t th√¢n k·ªãp th·ªùi!", inline=False)
                #G·ª° ph√≤ng h·ªô b·∫£n th√¢n
                ProfileMongoManager.remove_current_protection_item_profile(guild_id=interaction.guild_id, user_id=target_user.id)
                await me.edit(embed=embed, view=None, content=f"{target_user.mention}")
                return
            elif target_profile.protection_item.item_id == "armor_rob_2":
                #Random ch·ªçn gi·ªØa silver v√† copper
                silver_chance = self.get_chance(10)
                money = 0
                emoji = EmojiCreation2.COPPER.value
                if silver_chance and target_profile != None and target_profile.silver >= 5:
                    #Tr·ª´ 10% silver
                    money = int(user_profile.silver*0.1)
                    if money <= 0: money = 1000
                    if money > 10000: money = 10000
                    emoji = EmojiCreation2.SILVER.value
                    ProfileMongoManager.update_profile_money(guild_id=interaction.guild_id, guild_name= interaction.guild.name, user_id=user.id, user_name=user.name, user_display_name=user.display_name, silver=-money)
                else:
                    #Tr·ª´ 30% copper
                    money = int(user_profile.copper*0.3)
                    if money <= 0: money = 10000
                    if money > 100000: money = 100000
                    emoji = EmojiCreation2.COPPER.value
                    ProfileMongoManager.update_profile_money(guild_id=interaction.guild_id, guild_name= interaction.guild.name, user_id=user.id, user_name=user.name, user_display_name=user.display_name, copper=- money)
                embed = discord.Embed(title=f"", description=f"{user.mention} ƒëang chu·∫©n b·ªã c∆∞·ªõp ti·ªÅn c·ªßa {target_user.mention}!", color=0xc379e0)
                embed.add_field(name=f"", value=f"{target_user.mention} ƒë√£ m·∫∑c s·∫µn [{target_profile.protection_item.emoji} - **{target_profile.protection_item.item_name}**]!", inline=False)
                embed.add_field(name=f"", value=f"{EmojiCreation2.SHINY_POINT.value} {user.mention} ƒë√£ m·∫•t **{money}** {emoji}!", inline=False)
                #G·ª° ph√≤ng h·ªô b·∫£n th√¢n
                ProfileMongoManager.remove_current_protection_item_profile(guild_id=interaction.guild_id, user_id=target_user.id)
                await me.edit(embed=embed, view=None, content=f"{target_user.mention}")
                return
        
        result_text =f""
        if user_win:
            dignity_point = 10
            #Random ch·ªçn gi·ªØa silver v√† copper
            silver_chance = self.get_chance(10)
            money = 0
            emoji = EmojiCreation2.COPPER.value
            if silver_chance and target_profile != None and target_profile.silver >= 5:
                #Tr·ª´ 10% silver
                money = int(target_profile.silver*0.1)
                if money == 0: money = 1000
                if money > 50000: money = 50000
                emoji = EmojiCreation2.SILVER.value
            else:
                #Tr·ª´ 30% copper
                money = int(target_profile.copper*0.3)
                emoji = EmojiCreation2.COPPER.value
                if money == 0: money = 20000
                if money > 1500000: money = 1500000
            if user_profile.is_authority == True: money = money *2
            result_text = f"{user.mention} ƒë√£ th√†nh c√¥ng c∆∞·ªõp ƒë∆∞·ª£c **{money}** {emoji} c·ªßa {target_user.mention}!\nV√¨ h√†nh vi tr·ªôm c·∫Øp n√™n {user.mention} ƒë√£ m·∫•t **{dignity_point} nh√¢n ph·∫©m**!"
            #Tr·ª´ ti·ªÅn target_profile, c·ªông cho user_profile
            if emoji == EmojiCreation2.SILVER.value:
                ProfileMongoManager.update_profile_money(guild_id=interaction.guild_id, guild_name= interaction.guild.name, user_id=user.id, user_name=user.name, user_display_name=user.display_name, silver=money)
                ProfileMongoManager.update_profile_money(guild_id=interaction.guild_id, guild_name= interaction.guild.name, user_id=target_user.id, user_name=target_user.name, user_display_name=target_user.display_name, silver=-money)
            else:
                ProfileMongoManager.update_profile_money(guild_id=interaction.guild_id, guild_name= interaction.guild.name, user_id=user.id, user_name=user.name, user_display_name=user.display_name, copper=money)
                ProfileMongoManager.update_profile_money(guild_id=interaction.guild_id, guild_name= interaction.guild.name, user_id=target_user.id, user_name=target_user.name, user_display_name=target_user.display_name, copper=-money)
            #C·ªông kinh nghi·ªám cho ng∆∞·ªùi th·∫Øng
            ProfileMongoManager.update_level_progressing(guild_id=interaction.guild_id, user_id=user.id, bonus_exp=10)
            #Tr·ª´ nh√¢n ph·∫©m v√¨ c∆∞·ªõp gi·∫≠t
            ProfileMongoManager.update_dignity_point(guild_id=interaction.guild_id, guild_name=interaction.guild.name, user_id=user.id, user_name=user.name, user_display_name=user.display_name, dignity_point= -dignity_point)
        else:
            dignity_point = 15
            result_text += f"{user.mention} ƒë√£ kh√¥ng ƒë·ªß tr√¨nh ƒë·ªÉ c∆∞·ªõp ti·ªÅn c·ªßa {target_user.mention}!\nV√¨ h√†nh vi tr·ªôm c·∫Øp n√™n {user.mention} ƒë√£ m·∫•t **{dignity_point} nh√¢n ph·∫©m**!"
            #Tr·ª´ nh√¢n ph·∫©m ng∆∞·ªùi ƒë√°nh
            ProfileMongoManager.update_dignity_point(guild_id=interaction.guild_id, guild_name=interaction.guild.name, user_id=user.id, user_name=user.name, user_display_name=user.display_name, dignity_point= -dignity_point)
        new_embed = discord.Embed(title=f"", description=f"{result_text}", color=0xc379e0)
        try:
            await me.edit(embed=new_embed, view=None, content=f"{target_user.mention}")
        except Exception:
            return
    
    #region Fight
    async def process_fight_command(self, interaction: discord.Interaction, user: discord.Member, target_user: discord.Member, user_profile: Profile, target_profile: Profile):
        authority_user = ProfileMongoManager.get_authority(guild_id=user.guild.id)
        win_lines = [
                    "{user_name} ƒë√£ ch·ªçc v√†o m·∫Øt {target_name} v√† ƒë√£ th·∫Øng!",
                     "{user_name} ƒë√£ m√≥c s√∫ng ra, v√† {target_name} ƒë√£ ch·∫•p nh·∫≠n ho√† gi·∫£i!",
                     "{user_name} ƒë√£ nhanh ch√≥ng kh·ªëng ch·∫ø ƒë∆∞·ª£c {target_name}!",
                     "{user_name} ƒë√£ ra ƒë√≤n ch√≠ m·∫°ng, h·∫° con m·∫π n√≥ g·ª•c {target_name}!",
                     "{user_name} ƒë√£ ƒë√°nh b·∫°i {target_name} b·∫±ng k·ªπ nƒÉng th∆∞·ª£ng th·ª´a!",
                     "{user_name} ƒë√£ kho√° m·ªìm {target_name} th√†nh c√¥ng!",
                     "{user_name} ƒë√£ √°p ƒë·∫£o {target_name} ƒë·∫øn m·ª©c Mike Tyson ph·∫£i g·ªçi b·∫±ng m·ªìm!",
                     "{target_name} kh√¥ng h·ªÅ ƒë·ªß tu·ªïi so v·ªõi {user_name}!",
                     "{target_name} tu·ªïi con t√¥m v·ªõi {user_name}!",
                     "{target_name} c·ªë g·∫Øng ch·ªëng tr·∫£, nh∆∞ng {user_name} ƒë√£ ra tay ch·∫•m d·ª©t tr·∫≠n ƒë·∫•u!",
                     ]
        lose_lines = [
            "{user_name} kh√¥ng h·ªÅ ƒë·ªß tu·ªïi so v·ªõi {target_name}!",
            "{user_name} tu·ªïi con t√¥m v·ªõi {target_name}!",
            "{target_name} ƒë√£ g·ªçi anh em h·ªôi ƒë·ªông ng∆∞·ª£c l·∫°i {user_name}!",
            "{user_name} t∆∞·ªüng m√¨nh ngon, nh∆∞ng tu·ªïi l v·ªõi {target_name}!",
            "{user_name} ƒë√£ ƒëi sai n∆∞·ªõc, v√† b·ªã {target_name} ƒë√°nh l·∫°i cho b·∫ßm d·∫≠p!",
            "{user_name} ƒë√£ ch·ªçn sai ƒë·ªëi th·ªß, v√† b·ªã {target_name} ƒë√°nh cho l√™n b·ªù xu·ªëng ru·ªông!",
            "{user_name} ƒë√£ b·ªã {target_name} v·∫£ cho l·ªách m·ªìm!",
            "{user_name} ƒë·ªãnh lao ƒë·∫øn th√¨ {target_name} ƒë√£ m√≥c s√∫ng ra n√™n {user_name} ch·ªâ c√≥ th·ªÉ xin gi·∫£ng ho√†!",
            ]
        
        fighting_gif_link = [
            "https://i.pinimg.com/originals/bf/d4/7c/bfd47c06b2f98db0877b56d990e73662.gif",
            "https://i.pinimg.com/originals/bc/e4/b9/bce4b931cb3e21bedf6e9384fa19b6a3.gif",
            "https://i.pinimg.com/originals/41/bc/1a/41bc1ad4b1477371329a30b9e06466dd.gif",
            "https://i.pinimg.com/originals/36/c8/99/36c899aab751ae2e8d397592b1ea89a1.gif",
            "https://i.pinimg.com/originals/09/6a/2b/096a2b76d0b8c00c40a69547933ab7c8.gif",
        ]
        
        #Fight s·∫Ω d·ª±a v√†o level ƒë·ªÉ x√°c ƒë·ªãnh t·ªâ l·ªá th·∫Øng c·ªßa user v√† target_user
        user_win_fight = False
        if user_profile.is_authority == False:
            if user_profile.level < target_profile.level:
                user_win_fight = self.get_chance(25)
            else:
                if target_profile.is_authority == True:
                    user_win_fight = self.get_chance(35)
                else: user_win_fight = self.get_chance(75)
        else:
            user_win_fight = self.get_chance(40)
        
        preloading_text = f"{user.mention} ƒë√£ lao ƒë·∫øn ƒë√°nh l·ªôn v·ªõi {target_user.mention}!"
        if user_profile.is_authority == False:
            preloading_text += "\nC√≥ th·ªÉ g·ªçi Ch√≠nh Quy·ªÅn v√†o cu·ªôc ƒë·ªÉ ngƒÉn ch·∫∑n ·∫©u ƒë·∫£ n√†y!"
        embed = discord.Embed(title=f"", description=f"{preloading_text}", color=0xc379e0)
        fight_gif = random.choice(fighting_gif_link)
        embed.set_image(url=fight_gif)
        view = AuthorityInterceptView(user=user, user_profile=user_profile, crime_type="fight", target_profile=target_profile, target_user=target_user, authority_user=authority_user)
        await interaction.followup.send(f"B·∫°n ƒë√£ g√¢y g·ªó!", ephemeral=True)
        #Update last_crime
        ProfileMongoManager.update_last_crime(guild_id=interaction.guild_id, user_id=user.id)
        channel = interaction.channel
        if user_profile.is_authority == False:
            me = await channel.send(embed=embed, view=view, content=f"{target_user.mention}")
        else:
            me = await channel.send(embed=embed, view=None, content=f"{target_user.mention}")
        view.old_message = me
        #ƒê·ª£i ƒë·ªÉ x√°c ƒë·ªãnh ng∆∞·ªùi th·∫Øng
        await asyncio.sleep(20)
        if view.interrupted == True: return
        
        #Ki·ªÉm tra, c√≥ item b·∫£o h·ªô th√¨ k·∫øt qu·∫£ s·∫Ω kh√°c
        if target_profile.protection_item != None:
            if target_profile.protection_item.item_id == "hat_fight_1":
                embed = discord.Embed(title=f"", description=f"{user.mention} ƒë√£ lao ƒë·∫øn ƒë√°nh l·ªôn v·ªõi {target_user.mention}!", color=0xc379e0)
                embed.add_field(name=f"", value=f"{target_user.mention} ƒë√£ m·∫∑c s·∫µn [{target_profile.protection_item.emoji} - **{target_profile.protection_item.item_name}**] n√™n ƒë√£ tho√°t th√¢n k·ªãp th·ªùi!", inline=False)
                #G·ª° ph√≤ng h·ªô b·∫£n th√¢n
                ProfileMongoManager.remove_current_protection_item_profile(guild_id=interaction.guild_id, user_id=target_user.id)
                await me.edit(embed=embed, view=None, content=f"{target_user.mention}")
                return
            elif target_profile.protection_item.item_id == "hat_fight_2":
                embed = discord.Embed(title=f"", description=f"{user.mention} ƒë√£ lao ƒë·∫øn ƒë√°nh l·ªôn v·ªõi {target_user.mention}!", color=0xc379e0)
                embed.add_field(name=f"", value=f"{target_user.mention} ƒë√£ m·∫∑c s·∫µn [{target_profile.protection_item.emoji} - **{target_profile.protection_item.item_name}**]!", inline=False)
                embed.add_field(name=f"", value=f"{EmojiCreation2.SHINY_POINT.value} {user.mention} ƒë√£ b·ªã ƒë·∫•m ng∆∞·ª£c l·∫°i, v√† m·∫•t **20** nh√¢n ph·∫©m!", inline=False)
                #Tr·ª´ nh√¢n ph·∫©m user 
                ProfileMongoManager.update_dignity_point(guild_id=interaction.guild.id, guild_name=interaction.guild.name, user_id= user.id, user_name=user.name, user_display_name=user.display_name, dignity_point=-20)
                #G·ª° ph√≤ng h·ªô b·∫£n th√¢n
                ProfileMongoManager.remove_current_protection_item_profile(guild_id=interaction.guild_id, user_id=target_user.id)
                await me.edit(embed=embed, view=None, content=f"{target_user.mention}")
                return
        
        result_text =f""
        if user_win_fight:
            result_text = random.choice(win_lines)
            result_text = result_text.replace("{user_name}", user.mention)
            result_text = result_text.replace("{target_name}", target_user.mention)
            dignity_point = 15
            result_text += f"\n{user.mention} ƒë√£ ƒë√°nh th·∫Øng {target_user.mention} n√™n {target_user.mention} ƒë√£ m·∫•t **{dignity_point} nh√¢n ph·∫©m**!"
            #Tr·ª´ nh√¢n ph·∫©m ng∆∞·ªùi thua
            ProfileMongoManager.update_dignity_point(guild_id=interaction.guild_id, guild_name=interaction.guild.name, user_id=target_user.id, user_name=target_user.name, user_display_name=target_user.display_name, dignity_point= -dignity_point)
            #C·ªông kinh nghi·ªám cho ng∆∞·ªùi th·∫Øng
            ProfileMongoManager.update_level_progressing(guild_id=interaction.guild_id, user_id=user.id, bonus_exp=10)
            
        else:
            result_text = random.choice(lose_lines)
            result_text = result_text.replace("{user_name}", user.mention)
            result_text = result_text.replace("{target_name}", target_user.mention)
            dignity_point = 10
            result_text += f"\n{user.mention} ƒë√£ ƒë√°nh thua {target_user.mention}, n√™n {user.display_name} ƒë√£ b·ªã tr·ª´  **{dignity_point} nh√¢n ph·∫©m**!"
            #Tr·ª´ nh√¢n ph·∫©m ng∆∞·ªùi ƒë√°nh
            ProfileMongoManager.update_dignity_point(guild_id=interaction.guild_id, guild_name=interaction.guild.name, user_id=user.id, user_name=user.name, user_display_name=user.display_name, dignity_point= -dignity_point)
        new_embed = discord.Embed(title=f"", description=f"{result_text}", color=0xc379e0)
        new_embed.set_image(url=fight_gif)
        try:
            await me.edit(embed=new_embed, view=None, content=f"{target_user.mention}")
        except Exception:
            return
    
    
    #region Laundry
    async def process_laundry_command(self, interaction: discord.Interaction, user: discord.Member, target_user: discord.Member, user_profile: Profile, target_profile: Profile):
        authority_user = ProfileMongoManager.get_authority(guild_id=user.guild.id)
        #R·ª≠a ti·ªÅn th√¨ tu·ª≥ v√†o xem c√≥ ph·∫£i ch√≠nh quy·ªÅn kh√¥ng
        if user_profile.is_authority == False:
            user_win = self.get_chance(75)
        else:
            user_win = self.get_chance(40)
        
        preloading_text = f"{user.mention} ƒëang chu·∫©n b·ªã r·ª≠a ti·ªÅn v√† tr·ªën thu·∫ø!"
        if user_profile.is_authority == False:
            preloading_text += "\nC√≥ th·ªÉ g·ªçi Ch√≠nh Quy·ªÅn v√†o cu·ªôc ƒë·ªÉ ngƒÉn ch·∫∑n h√†nh vi r·ª≠a ti·ªÅn tr·ªën thu·∫ø!"
        embed = discord.Embed(title=f"", description=f"{preloading_text}", color=0xc379e0)
        view = AuthorityInterceptView(user=user, user_profile=user_profile, crime_type="laundry", target_profile=target_profile, target_user=target_user, authority_user=authority_user)
        await interaction.followup.send(f"B·∫°n ƒë√£ r·ª≠a ti·ªÅn v√† tr·ªën thu·∫ø!", ephemeral=True)
        #Update last_crime
        ProfileMongoManager.update_last_crime(guild_id=interaction.guild_id, user_id=user.id)
        channel = interaction.channel
        if user_profile.is_authority == False:
            me = await channel.send(embed=embed, view=view, content=f"")
        else:
            me = await channel.send(embed=embed, view=None, content=f"")
        view.old_message = me
        #ƒê·ª£i ƒë·ªÉ x√°c ƒë·ªãnh ng∆∞·ªùi th·∫Øng
        await asyncio.sleep(20)
        if view.interrupted == True: return
        result_text =f""
        if user_win:
            dignity_point = 15
            #Random ch·ªçn gi·ªØa silver v√† copper
            silver_chance = self.get_chance(10)
            money = 0
            emoji = EmojiCreation2.COPPER.value
            if silver_chance:
                #random 3 silver nh√¢n v·ªõi level c·ªßa user
                money = 2 * user_profile.level
                if money > 100: money = 100 #Cap l·∫°i
                emoji = EmojiCreation2.SILVER.value
            else:
                #random 3000 copper nh√¢n v·ªõi level c·ªßa user
                money = 3000 * user_profile.level
                if money > 85000: money = 85000 #Cap l·∫°i
                emoji = EmojiCreation2.COPPER.value
            if user_profile.is_authority == True: money = money *2
            result_text = f"{user.mention} ƒë√£ l√†m th·∫•t tho√°t **{money}** {emoji} c·ªßa Ch√≠nh Quy·ªÅn v√† b·ªè v√†o t√∫i c√° nh√¢n!\nV√¨ h√†nh vi r·ª≠a ti·ªÅn tr·ªën thu·∫ø n√™n {user.mention} ƒë√£ m·∫•t **{dignity_point} nh√¢n ph·∫©m**!"
            #Tr·ª´ ti·ªÅn ch√≠nh quy·ªÅn n·∫øu c√≥, c·ªông cho user_profile
            if emoji == EmojiCreation2.SILVER.value:
                ProfileMongoManager.update_profile_money(guild_id=interaction.guild_id, guild_name= interaction.guild.name, user_id=user.id, user_name=user.name, user_display_name=user.display_name, silver=money)
                if authority_user != None:
                    ProfileMongoManager.update_profile_money(guild_id=interaction.guild_id, guild_name= interaction.guild.name, user_id=authority_user.user_id, user_name=authority_user.user_name, user_display_name=authority_user.user_display_name, silver=-money)
            else:
                ProfileMongoManager.update_profile_money(guild_id=interaction.guild_id, guild_name= interaction.guild.name, user_id=user.id, user_name=user.name, user_display_name=user.display_name, copper=money)
                if authority_user != None:
                    ProfileMongoManager.update_profile_money(guild_id=interaction.guild_id, guild_name= interaction.guild.name, user_id=authority_user.user_id, user_name=authority_user.user_name, user_display_name=authority_user.user_display_name, copper=-money)
            #C·ªông kinh nghi·ªám cho ng∆∞·ªùi th·∫Øng
            ProfileMongoManager.update_level_progressing(guild_id=interaction.guild_id, user_id=user.id, bonus_exp=10)
            #Tr·ª´ nh√¢n ph·∫©m
            ProfileMongoManager.update_dignity_point(guild_id=interaction.guild_id, guild_name=interaction.guild.name, user_id=user.id, user_name=user.name, user_display_name=user.display_name, dignity_point= -dignity_point)
        else:
            dignity_point = 15
            result_text += f"{user.mention} ƒë√£ kh√¥ng ƒë·ªß tr√¨nh ƒë·ªÉ r·ª≠a ti·ªÅn v√† tr·ªën thu·∫ø!\nV√¨ h√†nh vi t·ªôi ƒë·ªì n√™n {user.mention} ƒë√£ m·∫•t **{dignity_point} nh√¢n ph·∫©m**!"
            #Tr·ª´ nh√¢n ph·∫©m
            ProfileMongoManager.update_dignity_point(guild_id=interaction.guild_id, guild_name=interaction.guild.name, user_id=user.id, user_name=user.name, user_display_name=user.display_name, dignity_point= -dignity_point)
        new_embed = discord.Embed(title=f"", description=f"{result_text}", color=0xc379e0)
        try:
            await me.edit(embed=new_embed, view=None, content=f"")
        except Exception:
            return
    
    #region smuggler
    async def process_smuggler_command(self, interaction: discord.Interaction, user: discord.Member, target_user: discord.Member, user_profile: Profile, target_profile: Profile):
        authority_user = ProfileMongoManager.get_authority(guild_id=user.guild.id)
        #R·ª≠a ti·ªÅn th√¨ tu·ª≥ v√†o xem c√≥ ph·∫£i ch√≠nh quy·ªÅn kh√¥ng
        if user_profile.is_authority == False:
            user_win = self.get_chance(75)
        else:user_win = self.get_chance(50)
        
        preloading_text = f"{user.mention} ƒëang chu·∫©n b·ªã bu√¥n l·∫≠u h√†ng c·∫•m!"
        if user_profile.is_authority == False:
            preloading_text += "\nC√≥ th·ªÉ g·ªçi Ch√≠nh Quy·ªÅn v√†o cu·ªôc ƒë·ªÉ ngƒÉn ch·∫∑n h√†nh vi bu√¥n l·∫≠u!"
        embed = discord.Embed(title=f"", description=f"{preloading_text}", color=0xc379e0)
        view = AuthorityInterceptView(user=user, user_profile=user_profile, crime_type="smuggler", target_profile=target_profile, target_user=target_user, authority_user=authority_user)
        await interaction.followup.send(f"B·∫°n ƒë√£ bu√¥n l·∫≠u!", ephemeral=True)
        #Update last_crime
        ProfileMongoManager.update_last_crime(guild_id=interaction.guild_id, user_id=user.id)
        channel = interaction.channel
        if user_profile.is_authority == False:
            me = await channel.send(embed=embed, view=view, content=f"")
        else:
            me = await channel.send(embed=embed, view=None, content=f"")
        view.old_message = me
        #ƒê·ª£i ƒë·ªÉ x√°c ƒë·ªãnh ng∆∞·ªùi th·∫Øng
        await asyncio.sleep(20)
        if view.interrupted == True: return
        result_text =f""
        if user_win:
            dignity_point = 10
            money = 3000 * user_profile.level - int(2000*user_profile.dignity_point/100)
            if money > 150000: money = 150000 #Cap l·∫°i
            if user_profile.is_authority == True: money = money *2
            result_text = f"{user.mention} ƒë√£ tu·ªìn l·∫≠u h√†ng c·∫•m v·ªÅ b√°n, v√† ki·∫øm l·ªùi ƒë∆∞·ª£c **{money}** {EmojiCreation2.COPPER.value}!\nV√¨ h√†nh vi bu√¥n l·∫≠u n√™n {user.mention} ƒë√£ m·∫•t **{dignity_point} nh√¢n ph·∫©m**!"
            #C·ªông cho user_profile
            ProfileMongoManager.update_profile_money(guild_id=interaction.guild_id, guild_name= interaction.guild.name, user_id=user.id, user_name=user.name, user_display_name=user.display_name, copper=money)
            #C·ªông kinh nghi·ªám cho ng∆∞·ªùi th·∫Øng
            ProfileMongoManager.update_level_progressing(guild_id=interaction.guild_id, user_id=user.id, bonus_exp=10)
            #Tr·ª´ nh√¢n ph·∫©m
            ProfileMongoManager.update_dignity_point(guild_id=interaction.guild_id, guild_name=interaction.guild.name, user_id=user.id, user_name=user.name, user_display_name=user.display_name, dignity_point= -dignity_point)
        else:
            dignity_point = 5
            result_text += f"{user.mention} ƒë√£ kh√¥ng th·ªÉ bu√¥n l·∫≠u n√™n m·∫•t lu√¥n ti·ªÅn v·ªën **2000** {EmojiCreation2.COPPER.value}!\nV√¨ h√†nh vi t·ªôi ƒë·ªì n√™n {user.mention} ƒë√£ m·∫•t th√™m **{dignity_point} nh√¢n ph·∫©m**!"
            ProfileMongoManager.update_profile_money(guild_id=interaction.guild_id, guild_name= interaction.guild.name, user_id=user.id, user_name=user.name, user_display_name=user.display_name, copper=-2000)
            #Tr·ª´ nh√¢n ph·∫©m
            ProfileMongoManager.update_dignity_point(guild_id=interaction.guild_id, guild_name=interaction.guild.name, user_id=user.id, user_name=user.name, user_display_name=user.display_name, dignity_point= -dignity_point)
        new_embed = discord.Embed(title=f"", description=f"{result_text}", color=0xc379e0)
        try:
            await me.edit(embed=new_embed, view=None, content=f"")
        except Exception:
            return
    
    
    def get_chance(self, chance: int):
        rand_num = random.randint(0, 100)
        if rand_num < chance:
            return True
        else:
            return False
        
    def check_if_within_time_delta(self, input: datetime, time_window: timedelta):
        now = datetime.now()
        if now - time_window <= input <= now + time_window:
            return True
        else:
            return False
    
        